@model List<HRM_Client.Models.SalaryScaleResponse>
@{
    ViewBag.Title = "Compensation Management";
    Layout = "_DashboardLayout";
    
    var adminScales = Model?.Where(s => s.Role == "Admin").ToList() ?? new List<HRM_Client.Models.SalaryScaleResponse>();
    var managerScales = Model?.Where(s => s.Role == "Manager").ToList() ?? new List<HRM_Client.Models.SalaryScaleResponse>();
    var employeeScales = Model?.Where(s => s.Role == "Employee").ToList() ?? new List<HRM_Client.Models.SalaryScaleResponse>();
}

<link rel="stylesheet" href="~/css/common-styles.css" />

<div class="content-header">
    <h1 class="content-title">Compensation</h1>
    <p class="content-subtitle">Manage base salary for each role and level</p>
</div>

<style>
    .compensation-container {
        display: flex;
        flex-direction: column;
        gap: 24px;
    }

    .role-section {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .role-section-title {
        font-size: 20px;
        font-weight: 400;
        color: #24292f;
    }

    .user-section {
        background-color: #ffffff;
        border: 1px solid #d0d7de;
        border-radius: 6px;
        overflow: hidden;
    }

    .scales-table {
        width: 100%;
        border-collapse: collapse;
    }

    .scales-table thead {
        background-color: #f6f8fa;
    }

    .scales-table th {
        padding: 12px 20px;
        text-align: left;
        font-size: 13px;
        font-weight: 500;
        color: #57606a;
        border-bottom: 1px solid #d0d7de;
    }

    .scales-table td {
        padding: 16px 20px;
        font-size: 14px;
        color: #24292f;
        border-bottom: 1px solid #d0d7de;
    }

    .scales-table tbody tr:last-child td {
        border-bottom: none;
    }

    .scales-table tbody tr:hover {
        background-color: #f6f8fa;
    }

    .salary-input {
        width: 100%;
        max-width: 200px;
        padding: 8px 12px;
        font-size: 14px;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
        border: 1px solid #d0d7de;
        border-radius: 6px;
        outline: none;
        transition: border-color 0.2s, box-shadow 0.2s;
    }

    .salary-input:focus {
        border-color: #0969da;
        box-shadow: 0 0 0 3px rgba(9, 105, 218, 0.1);
    }

    .salary-input.error {
        border-color: #cf222e;
    }

    .salary-input.error:focus {
        box-shadow: 0 0 0 3px rgba(207, 34, 46, 0.1);
    }

    .btn-save {
        padding: 6px 12px;
        font-size: 13px;
        font-weight: 400;
        border: 1px solid #d0d7de;
        border-radius: 6px;
        background-color: #0969da;
        color: #ffffff;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .btn-save:hover {
        background-color: #0860ca;
    }

    .btn-save:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .error-message {
        font-size: 13px;
        color: #cf222e;
        margin-top: 4px;
    }

    .level-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        background-color: #f6f8fa;
        border: 1px solid #d0d7de;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        color: #24292f;
    }
</style>

<div class="compensation-container">
    <!-- Admin Section -->
    @if (adminScales.Any())
    {
        <div class="role-section">
            <div class="collapsible-header" onclick="toggleSection(this)">
                <svg class="collapse-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
                <h2 class="role-section-title">Admin</h2>
            </div>
            
            <div class="collapsible-content">
            <div class="user-section">
            <table class="scales-table">
                <thead>
                    <tr>
                        <th style="width: 20%;">Level</th>
                        <th style="width: 40%;">Base Salary (VND)</th>
                        <th style="width: 30%;">Description</th>
                        <th style="width: 10%;"></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var scale in adminScales)
                    {
                        <tr>
                            <td>
                                <span class="level-badge level-@scale.Level">@scale.Level</span>
                            </td>
                            <td>
                                <input type="number" 
                                       class="salary-input" 
                                       id="salary-@scale.Id" 
                                       value="@scale.BaseSalary" 
                                       min="0" 
                                       max="999999999"
                                       step="1000000" />
                                <div id="error-@scale.Id" class="error-message" style="display: none;"></div>
                            </td>
                            <td>@scale.Description</td>
                            <td>
                                <button class="btn-save" onclick="updateSalary(@scale.Id)">Save</button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
            </div>
            </div>
        </div>
    }

    <!-- Manager Section -->
    @if (managerScales.Any())
    {
        <div class="role-section">
            <div class="collapsible-header" onclick="toggleSection(this)">
                <svg class="collapse-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
                <h2 class="role-section-title">Manager</h2>
            </div>
            
            <div class="collapsible-content">
            <div class="user-section">
            <table class="scales-table">
                <thead>
                    <tr>
                        <th style="width: 20%;">Level</th>
                        <th style="width: 40%;">Base Salary (VND)</th>
                        <th style="width: 30%;">Description</th>
                        <th style="width: 10%;"></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var scale in managerScales)
                    {
                        <tr>
                            <td>
                                <span class="level-badge level-@scale.Level">@scale.Level</span>
                            </td>
                            <td>
                                <input type="number" 
                                       class="salary-input" 
                                       id="salary-@scale.Id" 
                                       value="@scale.BaseSalary" 
                                       min="0" 
                                       max="999999999"
                                       step="1000000" />
                                <div id="error-@scale.Id" class="error-message" style="display: none;"></div>
                            </td>
                            <td>@scale.Description</td>
                            <td>
                                <button class="btn-save" onclick="updateSalary(@scale.Id)">Save</button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
            </div>
            </div>
        </div>
    }

    <!-- Employee Section -->
    @if (employeeScales.Any())
    {
        <div class="role-section">
            <div class="collapsible-header" onclick="toggleSection(this)">
                <svg class="collapse-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
                <h2 class="role-section-title">Employee</h2>
            </div>
            
            <div class="collapsible-content">
            <div class="user-section">
            <table class="scales-table">
                <thead>
                    <tr>
                        <th style="width: 20%;">Level</th>
                        <th style="width: 40%;">Base Salary (VND)</th>
                        <th style="width: 30%;">Description</th>
                        <th style="width: 10%;"></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var scale in employeeScales)
                    {
                        <tr>
                            <td>
                                <span class="level-badge level-@scale.Level">@scale.Level</span>
                            </td>
                            <td>
                                <input type="number" 
                                       class="salary-input" 
                                       id="salary-@scale.Id" 
                                       value="@scale.BaseSalary" 
                                       min="0" 
                                       max="999999999"
                                       step="1000000" />
                                <div id="error-@scale.Id" class="error-message" style="display: none;"></div>
                            </td>
                            <td>@scale.Description</td>
                            <td>
                                <button class="btn-save" onclick="updateSalary(@scale.Id)">Save</button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
            </div>
            </div>
        </div>
    }
</div>

<!-- Toast Notification -->
<div id="toast" style="display: none; position: fixed; top: 24px; right: 24px; background-color: #ffffff; border: 1px solid #d0d7de; border-radius: 6px; padding: 16px 20px; box-shadow: 0 4px 12px rgba(27, 31, 36, 0.15); z-index: 1001; min-width: 300px;">
    <div style="display: flex; align-items: start; gap: 12px;">
        <div id="toastIcon" style="flex-shrink: 0; width: 20px; height: 20px;"></div>
        <div style="flex: 1;">
            <div id="toastTitle" style="font-size: 14px; font-weight: 500; color: #24292f; margin-bottom: 4px;"></div>
            <div id="toastMessage" style="font-size: 13px; color: #57606a;"></div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function toggleSection(header) {
            const content = header.nextElementSibling;
            const icon = header.querySelector('.collapse-icon');
            
            content.classList.toggle('collapsed');
            icon.classList.toggle('collapsed');
        }

        function showToast(title, message, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toastIcon');
            
            document.getElementById('toastTitle').textContent = title;
            document.getElementById('toastMessage').textContent = message;
            
            if (type === 'success') {
                icon.innerHTML = '<svg style="color: #1a7f37;" width="20" height="20" viewBox="0 0 16 16" fill="currentColor"><path d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path></svg>';
            } else {
                icon.innerHTML = '<svg style="color: #cf222e;" width="20" height="20" viewBox="0 0 16 16" fill="currentColor"><path d="M3.72 3.72a.75.75 0 011.06 0L8 6.94l3.22-3.22a.75.75 0 111.06 1.06L9.06 8l3.22 3.22a.75.75 0 11-1.06 1.06L8 9.06l-3.22 3.22a.75.75 0 01-1.06-1.06L6.94 8 3.72 4.78a.75.75 0 010-1.06z"></path></svg>';
            }
            
            toast.style.display = 'block';
            setTimeout(() => {
                toast.style.display = 'none';
            }, 4000);
        }

        async function updateSalary(id) {
            const input = document.getElementById(`salary-${id}`);
            const errorDiv = document.getElementById(`error-${id}`);
            const baseSalary = parseFloat(input.value);

            // Clear previous error
            errorDiv.style.display = 'none';
            input.classList.remove('error');

            // Validation
            if (isNaN(baseSalary) || baseSalary < 0 || baseSalary > 999999999) {
                errorDiv.textContent = 'Base salary must be between 0 and 999,999,999';
                errorDiv.style.display = 'block';
                input.classList.add('error');
                return;
            }

            try {
                const response = await fetch('@Url.Action("Update", "Compensation")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        id: id,
                        baseSalary: baseSalary
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showToast('Success', result.message, 'success');
                    input.value = result.baseSalary;
                } else {
                    showToast('Error', result.message, 'error');
                    errorDiv.textContent = result.message;
                    errorDiv.style.display = 'block';
                    input.classList.add('error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('Error', 'An error occurred while updating salary', 'error');
            }
        }

        // Allow enter key to save
        document.querySelectorAll('.salary-input').forEach(input => {
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const id = this.id.replace('salary-', '');
                    updateSalary(id);
                }
            });

            // Clear error on input change
            input.addEventListener('input', function() {
                const id = this.id.replace('salary-', '');
                const errorDiv = document.getElementById(`error-${id}`);
                errorDiv.style.display = 'none';
                this.classList.remove('error');
            });
        });
    </script>
}

